<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
</head>
<body>
{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container" style="max-width:1100px; margin:24px auto;">
  <h2 class="fw-bold mb-3">Outfit Planner</h2>

  <div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="planForm">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Plan outfit</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input type="date" class="form-control" name="date" id="planDate" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Outfit</label>
              <select class="form-select" name="outfit" id="planOutfit" required>
                {% for o in outfits %}
                  <option value="{{ o.id }}"
                          data-img="{{ o.image.url }}"
                          data-style="{{ o.predicted_style }}"
                          data-rating="{{ o.rating }}">
                    #{{ o.id }} • {{ o.predicted_style }} • ⭐{{ o.rating }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Note (optional)</label>
              <input type="text" class="form-control" name="note" id="planNote" maxlength="120">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-brand">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="calendar"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<style>
  #calendar .fc-toolbar-title{ font-weight:800; }
  .fc .fc-button-primary{ background:#C68B59; border-color:#C68B59; }
  .fc .fc-button-primary:hover{ background:#A97142; border-color:#A97142; }


  #calendar .fc-daygrid-event,
  #calendar .fc-timegrid-event{
    background: transparent !important;
    border: 0 !important;
    padding: 0 !important;
  }
  #calendar .fc-event-title{ display:none; }

  .event-thumb{
    width: 70px;
    height: 100px;
    border-radius: 12px;
    overflow: hidden;
    margin: 0 auto;
    box-shadow: 0 2px 6px rgba(0,0,0,.15);
    border: 1px solid #eee;
  }
  .event-thumb img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    display:block;
  }
  #calendar .fc-daygrid-day-events .fc-daygrid-event-harness{ margin: 3px 0; }

  .plan-card{ display:flex; align-items:center; gap:10px; padding:6px 8px; background:#fff; border:1px solid #eee; border-radius:10px; }
  .plan-card img{ width:100px; height:140px; object-fit:cover; border-radius:8px; }
  .plan-card .meta{ font-size:12px; color:#555; }
  .toast{ position: fixed; right:16px; bottom:16px; z-index:1080; }


    @media (max-width: 768px){
      #calendar .fc-header-toolbar{
        flex-wrap:wrap;
        row-gap:6px;
      }
      #calendar .fc-toolbar-title{ font-size:1.1rem; }

      .event-thumb{ width:54px; height:80px; border-radius:10px; }
      #calendar .fc-daygrid-day-events .fc-daygrid-event-harness{ margin:2px 0; }

      .fc .fc-button{ padding:4px 8px; font-size:.9rem; }
    }

    @media (max-width: 360px){
      .event-thumb{ width:48px; height:70px; }
    }

</style>

<script>
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const modalEl = document.getElementById('planModal');
  const planModal = new bootstrap.Modal(modalEl);
  const form = document.getElementById('planForm');
  const dateInput = document.getElementById('planDate');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    selectable: true,
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek' },
    events: '{% url "calendar_events" %}',

    eventContent: function(arg){
      const p = arg.event.extendedProps;
      const wrap = document.createElement('div');
      wrap.className = 'event-thumb';
      const img = document.createElement('img');
      img.src = p.image;
      img.alt = arg.event.title;
      img.title = arg.event.title + (p.note ? (' • ' + p.note) : '');
      wrap.appendChild(img);
      return { domNodes: [wrap] };
    },

    dateClick: function(info){
      form.reset();
      dateInput.value = info.dateStr;
      planModal.show();
    },

    eventClick: function(info){
      const p = info.event.extendedProps;
      const wrap = document.createElement('div');
      wrap.className = 'toast show';
      wrap.innerHTML = `
        <div class="toast-body">
          <div class="plan-card">
            <img src="${p.image}" alt="">
            <div>
              <div><strong>${info.event.title}</strong></div>
              <div class="meta">${info.event.startStr}${p.note ? ' • '+p.note : ''}</div>
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-danger" id="delBtn">Delete</button>
              </div>
            </div>
          </div>
        </div>`;
      document.body.appendChild(wrap);

      wrap.querySelector('#delBtn').addEventListener('click', async () => {
        await fetch('{% url "calendar_delete" 0 %}'.replace('/0/', `/${info.event.id}/`), {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        wrap.remove();
        calendar.refetchEvents();
      });

      setTimeout(()=> wrap.remove(), 5000);
    }
  });

  calendar.render();

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const resp = await fetch('{% url "calendar_add" %}', {
      method:'POST',
      body: fd,
      headers: { 'X-CSRFToken': getCookie('csrftoken') }
    });
    if(resp.ok){
      planModal.hide();
      calendar.refetchEvents();
    }
  });

  new TomSelect("#planOutfit", {
    render: {
      option: function(data, escape) {
        return `
          <div style="display:flex;align-items:center;gap:8px;">
            <img src="${escape(data.img)}"
                 style="width:40px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #ccc;">
            <div>
              <div><strong>#${escape(data.value)}</strong> • ${escape(data.style)}</div>
              <div style="font-size:12px;color:#666;">⭐ ${escape(data.rating)}</div>
            </div>
          </div>`;
      },
      item: function(data, escape) {
        return `
          <div style="display:flex;align-items:center;gap:6px;">
            <img src="${escape(data.img)}"
                 style="width:28px;height:36px;object-fit:cover;border-radius:4px;border:1px solid #ccc;">
            <span>#${escape(data.value)} • ${escape(data.style)} • ⭐${escape(data.rating)}</span>
          </div>`;
      }
    },
    plugins: ['dropdown_input'],
    copyClassesToDropdown: false,
    onInitialize: function() {
      this.options = {};
      document.querySelectorAll("#planOutfit option").forEach(opt => {
        this.addOption({
          value: opt.value,
          text: opt.textContent,
          img: opt.dataset.img,
          style: opt.dataset.style,
          rating: opt.dataset.rating
        });
      });
    }
  });
});
</script>

{% endblock %}
</body>
</html>
